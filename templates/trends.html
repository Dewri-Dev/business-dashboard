<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Performance Trends</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c7be5;
            --primary-light: #e3effc;
            --danger: #e63757;
            --dark: #12263f;
            --gray: #95aac9;
            --bg: #f9fbfd;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--dark);
            margin: 0;
            padding: 40px 20px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 1000px;
            width: 100%;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: var(--dark);
            margin: 0 0 12px 0;
            font-size: 32px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        p.subtitle {
            color: var(--gray);
            margin: 0;
            font-size: 16px;
        }

        .card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            border: 1px solid #edf2f9;
            box-shadow: 0 10px 30px rgba(18, 38, 63, 0.05);
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-bottom: 30px;
        }

        .footer-actions {
            text-align: center;
            border-top: 1px solid #edf2f9;
            padding-top: 30px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background-color: white;
            color: var(--primary);
            text-decoration: none;
            border: 2px solid var(--primary-light);
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .back-link:hover {
            background-color: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .back-link svg {
            width: 18px;
            height: 18px;
            transition: transform 0.2s;
        }

        .back-link:hover svg {
            transform: translateX(-4px);
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Performance Trends</h1>
            <p class="subtitle">Historical tracking of your Revenue vs Expenses</p>
        </header>

        <div class="card">
            <div class="chart-container">
                <canvas id="largeTrendsChart"></canvas>
            </div>

            <div class="footer-actions">
                <a href="/dashboard" class="back-link">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <script>
        async function loadChart() {
            try {
                let data;
                
                try {
                    // Check if running in a preview environment (blob/null origin)
                    const isPreview = window.location.protocol === 'blob:' || window.location.protocol === 'data:' || window.location.origin === 'null';
                    
                    // Use absolute URL for preview fallback, relative URL for actual app
                    const fetchUrl = isPreview ? 'http://127.0.0.1:5000/trends' : '/trends';
                    
                    const response = await fetch(fetchUrl);
                    if (!response.ok) throw new Error("Network response was not ok");
                    data = await response.json();
                } catch (fetchError) {
                    console.warn("Backend not reachable or running in preview. Using mock data.", fetchError);
                    // Mock data fallback so the chart still renders beautifully in Canvas
                    data = [
                        { date: '2026-01-01', revenue: 150000, expenses: 80000 },
                        { date: '2026-01-15', revenue: 165000, expenses: 85000 },
                        { date: '2026-02-01', revenue: 160000, expenses: 82000 },
                        { date: '2026-02-15', revenue: 180000, expenses: 90000 },
                        { date: '2026-03-01', revenue: 210000, expenses: 95000 },
                        { date: '2026-03-15', revenue: 258000, expenses: 55000 }
                    ];
                }

                // Sort data by date
                data.sort((a, b) => new Date(a.date) - new Date(b.date));

                const labels = data.map(item => item.date);
                const revenues = data.map(item => item.revenue);
                const expenses = data.map(item => item.expenses);

                const ctx = document.getElementById('largeTrendsChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Revenue (₹)',
                                data: revenues,
                                borderColor: '#2c7be5',
                                backgroundColor: 'rgba(44, 123, 229, 0.15)',
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#2c7be5',
                                pointBorderWidth: 2,
                                pointRadius: 4
                            },
                            {
                                label: 'Expenses (₹)',
                                data: expenses,
                                borderColor: '#e63757',
                                borderDash: [5, 5],
                                backgroundColor: 'transparent',
                                fill: false,
                                tension: 0.4,
                                pointBackgroundColor: '#e63757',
                                pointRadius: 4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { font: { family: "'Segoe UI', sans-serif", size: 14 } }
                            },
                            tooltip: {
                                backgroundColor: '#12263f',
                                titleFont: { size: 14 },
                                bodyFont: { size: 14 },
                                padding: 12,
                                cornerRadius: 8
                            }
                        },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: { color: '#edf2f9' },
                                ticks: { font: { size: 12 } }
                            },
                            x: { 
                                grid: { display: false },
                                ticks: { font: { size: 12 } }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error("Failed to load chart data:", error);
            }
        }

        window.onload = loadChart;
    </script>
</body>
</html>